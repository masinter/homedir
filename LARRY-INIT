(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "XCL" BASE 10 FORMAT XCCS)
(FILECREATED "14-Aug-2021 21:59:49" |{DSK}<home>larry>id>LARRY-INIT.;31| 9440   

      |previous| |date:| "13-Aug-2021 13:34:59" |{DSK}<home>larry>id>LARRY-INIT.;26|)


(PRETTYCOMPRINT LARRY-INITCOMS)

(RPAQQ LARRY-INITCOMS
       ((VARS MAXDEPTH (DWIMWAIT 600)
              (MAXLEVEL 30000)
              (MAXLOOP 30000))
        (VARS (BADFILESFILE '|/home/larry/id/BADFILES|)
              (BADFS (OPENSTREAM BADFILESFILE 'APPEND))
              (BADFILES (READFILE BADFILESFILE)))
        (FNS BACKGROUND-YIELD BADFILE GATHER-INFO INIT-YIELD MAKE-PS)
        (P (PUSHNEW \\INITSUBRS '(YIELD 210))
           (PUSHNEW DIRECTORIES (MEDLEYDIR "greetfiles"))
           (|pushnew| DIRECTORIES (MEDLEYDIR "docs/documentation tools"))
           (PUSHNEW BEFORESYSOUTFORMS '(INIT-YIELD NIL)))
        (FILES SAMEDIR WHEELSCROLL CLIPBOARD MODERNIZE MEDLEY-UTILS IMINDEX IMNAME IMTEDIT IMTOOLS 
               IMTRAN MATHTONS EQUATIONS DOC-OBJECTS SKETCH)
        (P (VIDEOCOLOR T)
           (POSTSCRIPT.INIT))
        (ADVISE TEDIT.PROMPTPRINT)))

(RPAQQ MAXDEPTH 30000)

(RPAQQ DWIMWAIT 600)

(RPAQQ MAXLEVEL 30000)

(RPAQQ MAXLOOP 30000)

(RPAQQ BADFILESFILE |/home/larry/id/BADFILES|)

(RPAQ BADFS (OPENSTREAM BADFILESFILE 'APPEND))

(RPAQ BADFILES (READFILE BADFILESFILE))
(DEFINEQ

(BACKGROUND-YIELD
  (LAMBDA NIL                                         (* \; "Edited  2-Mar-2021 14:31 by larry")
    (SUBRCALL YIELD (CONSTANT (ITIMES 833333)))
    (SUBRCALL CAUSE-INTERRUPT)))

(BADFILE
  (LAMBDA (X)                                         (* \; "Edited 13-Aug-2021 13:31 by larry")
    (|pushnew| BADFILES (OR X TFILE))
    (PRINT (OR X TFILE)
           BADFS)
    (FLUSHOUTPUT BADFS)
    (RETFROM 'MAKE-PS NIL)))

(GATHER-INFO
  (LAMBDA (PHASE)                                     (* \; "Edited 22-Jul-2021 09:36 by larry")
    (SELECTQ PHASE
        (1 (SETQ LOADEDFILES (|for| X |in| LOADEDFILELST |collect| (FILENAMEFIELD
                                                                                X
                                                                                'NAME)))
           (FILESLOAD FILESETS)
           (SETQ ALLFILESETSFILES (|for| X |in| FILESETS |join| (APPEND (EVAL X))))
           (SETQ SOURCES (|for| X |in| (DIRECTORY (MEDLEYDIR "sources" "*.*;" T))
                            |when| (NOT (MEMB (FILENAMEFIELD X 'EXTENSION)
                                                  '(LCOM DFASL TEDIT TXT)))
                            |collect| (FILENAMEFIELD X 'NAME))))
        (-1 (PRINTOUT T " loaded files not in SYSFILES or FILELST: "
                   (|for| X |in| LOADEDFILES |when| (NOT (OR (FMEMB X SYSFILES)
                                                                         (FMEMB X FILELST)))
                      |collect| X)
                   T)
            (PRINTOUT T "Sources not loaded: " (CL:SET-DIFFERENCE SOURCES (APPEND ALLFILESETSFILES 
                                                                                 LOADEDFILES))
                   T)
            (PRINTOUT T "Files in FILESETS not loaded " (CL:SET-DIFFERENCE ALLFILESETSFILES 
                                                               LOADEDFILES)
                   T))
        (2 (SETQ DEFINEDFNS (LET ((DEFD NIL))
                                 (MAPATOMS (FUNCTION (CL:LAMBDA (X)
                                                            (CL:WHEN (GETD X)
                                                                (CL:SETQ DEFD (CONS X DEFD))))))
                                 DEFD))
           (|for| X |in| DEFINEDFNS |when| (CCODEP X)
              |do| (LET ((Y (PUTPROP X 'CCC (CALLSCCODE X))))
                            (|for| REV |in| '(BLOCK-CALLED-BY CALLED-BY SPECIAL-BY GLOBAL-BY)
                               |as| VAL |in| Y
                               |do| (|for| S |in| VAL
                                           |do| (PUTPROP S REV (CONS X (GETPROP S REV)))))))
           (SETQ CALLEDFNS NIL)
           (MAPATOMS (FUNCTION (LAMBDA (X)
                                 (|if| (AND (NOT (GETD X))
                                                (GETPROP X 'CALLED-BY))
                                     |then| (CL:PUSH X CALLEDFNS))))))
        (-2 (PRINTOUT T "Functions called and not defined" CALLEDFNS T))
        (3 (|for| X |in| SYSFILES
              |do|
              (LOAD X 'PROP)
              (PUTPROP X 'CONTENT (READFILE X))
              (|for| EXR |in| (GETPROP X 'CONTENT)
                 |do| (SELECTQ (CAR EXR)
                              (DEFINEQ (|for| DFN |in| (CDR EXR)
                                          |do| (|if| (EQUAL (CADR DFN)
                                                                    (GETPROP (CAR DFN)
                                                                           'EXPR))
                                                       |then| (PRINTOUT T (CAR DFN)
                                                                         " ")
                                                             (PUTPROP (CAR DFN)
                                                                    'EXPR
                                                                    (CADR DFN))
                                                     |else| (PRINTOUT T (CAR DFN)
                                                                       "* "))))
                              NIL)))
           (SETQ ALLCONTENT (|for| X |in| SYSFILES |collect| (CONS X (GETPROP
                                                                                  X
                                                                                  'CONTENT))))
                                                             (* \; " don't edit with SEDIT")
           (LET (DUPS)
                (|for| X |in| SYSFILES
                   |do| (|for| FN |in| (FILEFNSLST X)
                               |do| (|if| (GETPROP FN 'WHEREIS)
                                            |then| (NCONC1 (GETPROP FN 'WHEREIS)
                                                              X)
                                                  (OR (FMEMB FN DUPS)
                                                      (SETQ DUPS (CONS FN DUPS)))
                                          |else| (PUTPROP FN 'WHEREIS (LIST X)))))
                (SETQ DUPFNS DUPS))
           (SETQ NO-SOURCE (|for| X |in| DEFINEDFNS |when| (NOT (GETPROP X 'EXPR))
                              |collect| X)))
        (-3 (PRINTOUT T "Functions compiled but no expr" NO-SOURCE T)
            (PRINTOUT T "Functions on more than one file: " DUPFNS T))
        (4 (|for| X |in| SYSFILES |do| (MASTERSCOPE `(ANALYZE ON ',X))))
        (-4 "No queries yet")
        (HELP))))

(INIT-YIELD
  (LAMBDA (ONP)
    (|if| ONP
        |then| (|pushnew| BACKGROUNDFNS 'BACKGROUND-YIELD)
      |else| (SETQ BACKGROUNDFNS (REMOVE 'BACKGROUND-YIELD 'BACKGROUNDFNS)))))

(MAKE-PS
  (LAMBDA (TFILE)                                     (* \; "Edited 12-Aug-2021 21:54 by larry")
    (DECLARE (SPECVARS TFILE))
    (COND
       ((DIRECTORYNAMEP TFILE)

        (* |;;| "first deal with files in this directory")

        (|for| X |in| (DIRECTORY (CONCAT (SETQ TFILE (DIRECTORYNAME TFILE))
                                                "*.TED*;")
                                     NIL NIL) |when| (NOT (MEMB X BADFILES))
           |do| (MAKE-PS X))

        (* |;;| " then deal with subdirs ")

        (|for| X |in| (DIRECTORY (CONCAT TFILE "*"))
           |when| (|for| SKIP |in| '(">." ">internal>test" ">dinfo>")
                         |always| (NOT (STRPOS SKIP (L-CASE X)))) |when| (DIRECTORYNAMEP
                                                                                  X)
           |do| (MAKE-PS X)))
       ((SETQ TFILE (INFILEP TFILE))
        (LET ((PSFILE (PACKFILENAME.STRING 'EXTENSION "PS" 'BODY TFILE))
              (TEXTSTREAM))
             (|if| (INFILEP PSFILE)
                 |then|                                  (* \; " do nothing")
                       NIL
               |else| (PRINTOUT T "Converting " TFILE "...")
                     (TEDIT.FORMAT.HARDCOPY (OPENTEXTSTREAM TFILE)
                            PSFILE T NIL NIL NIL 'POSTSCRIPT)
                     (TERPRI T)
                     (CLOSEF? TEXTSTREAM))))
       (T (PRINTOUT T "no such file " T)))))
)

(PUSHNEW \\INITSUBRS '(YIELD 210))

(PUSHNEW DIRECTORIES (MEDLEYDIR "greetfiles"))

(|pushnew| DIRECTORIES (MEDLEYDIR "docs/documentation tools"))

(PUSHNEW BEFORESYSOUTFORMS '(INIT-YIELD NIL))

(FILESLOAD SAMEDIR WHEELSCROLL CLIPBOARD MODERNIZE MEDLEY-UTILS IMINDEX IMNAME IMTEDIT IMTOOLS IMTRAN
       MATHTONS EQUATIONS DOC-OBJECTS SKETCH)

(VIDEOCOLOR T)

(POSTSCRIPT.INIT)

(XCL:REINSTALL-ADVICE 'TEDIT.PROMPTPRINT :BEFORE '((:LAST (PRIN1 MSG T))))

(READVISE TEDIT.PROMPTPRINT)
(DECLARE\: DONTCOPY
  (FILEMAP (NIL (1395 8912 (BACKGROUND-YIELD 1405 . 1612) (BADFILE 1614 . 1868) (GATHER-INFO 1870 . 7168
) (INIT-YIELD 7170 . 7369) (MAKE-PS 7371 . 8910)))))
STOP
