(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "INTERLISP" BASE 10)
(FILECREATED "29-Aug-2021 08:11:53" {DSK}<home>larry>id>MAKE-PS.;1 4786   

      changes to%:  (VARS MAKE-PSCOMS)
                    (FNS MAKE-PS BADFILE))


(PRETTYCOMPRINT MAKE-PSCOMS)

(RPAQQ MAKE-PSCOMS
       [(FNS BADFILE MAKE-PS)
        (ADVISE TEDIT.PROMPTPRINT)
        (VARS (BADFILESFILE '/home/larry/id/BADFILES)
              (BADFS (OPENSTREAM BADFILESFILE 'APPEND))
              (BADFILES (SUBSET (READFILE BADFILESFILE)
                               (FUNCTION INFILEP])
(DEFINEQ

(BADFILE
  [LAMBDA (X)                                          (* ; "Edited 16-Aug-2021 13:14 by larry")
    ([LAMBDA ($$1)
       (COND
          ((FMEMB $$1 BADFILES)
           BADFILES)
          (T (NCONC1 BADFILES $$1]
     (OR X TFILE))
    (PRINT (OR X TFILE)
           BADFS)
    (FLUSHOUTPUT BADFS)
    (CLOSEF? TEXTSTREAM)
    (RETFROM 'MAKE-PS NIL])

(MAKE-PS
  [LAMBDA (TFILE PREFIX DEST REDOFLG TOPDIRLEN)        (* ; "Edited 21-Aug-2021 20:56 by larry")
    (DECLARE (SPECVARS TFILE))
    (COND
       ((DIRECTORYNAMEP TFILE)
        (SETQ TFILE (DIRECTORYNAME TFILE))
        [OR TOPDIRLEN (SETQ TOPDIRLEN (IPLUS 1 (CL:LENGTH (MKSTRING (FILENAMEFIELD TFILE 'DIRECTORY]
        [OR DEST (PROGN (ShellCommand (CONCAT "mkdir -p " (UNIX-GETENV "MEDLEYDIR")
                                             "/tmp/psfiles"))
                        (SETQ DEST (MEDLEYDIR "tmp/psfiles"]

        (* ;; "first deal with files in this directory")

        (for X in (IF (EQ REDOFLG 'REV)
                              THEN (REVERSE (DIRECTORY (CONCAT TFILE "*.TED*;")))
                            ELSE (DIRECTORY (CONCAT TFILE "*.TED*;")))
           when (NOT (MEMB X BADFILES)) do (MAKE-PS X PREFIX DEST REDOFLG TOPDIRLEN))

        (* ;; " then deal with subdirs ")

        (for X in (IF (EQ REDOFLG 'REV)
                              THEN (REVERSE (DIRECTORY (CONCAT TFILE "*")))
                            ELSE (DIRECTORY (CONCAT TFILE "*")))
           when [for SKIP in '(">." ">internal>test" ">dinfo>")
                       always (NOT (STRPOS SKIP (L-CASE X] when (DIRECTORYNAMEP X)
           do (MAKE-PS X PREFIX DEST REDOFLG TOPDIRLEN)))
       [(SETQ TFILE (INFILEP TFILE))
        (PROG ((PSFILE (PACKFILENAME.STRING 'EXTENSION (if (EQ REDOFLG 'IP)
                                                           then 'IP
                                                         else "PS")
                              'NAME
                              (CONCAT (OR PREFIX "")
                                     (if PREFIX
                                         then "-"
                                       else "")
                                     [PACK (SUBST '- '> (UNPACK (SUBSTRING (FILENAMEFIELD
                                                                            TFILE
                                                                            'DIRECTORY)
                                                                       (IPLUS 1 TOPDIRLEN)
                                                                       -1]
                                     "-"
                                     (FILENAMEFIELD TFILE 'NAME))
                              'DIRECTORY DEST))
               (TEXTSTREAM))
              (if (MEMB TFILE BADFILES)
                  then (RETURN))
              (if (AND (NOT REDOFLG)
                           (INFILEP PSFILE))
                  then                                   (* ; " do nothing")
                        (PRINTOUT T PSFILE " already there" T)
                elseif (EQ REDOFLG 'TEST)
                  then (PRINTOUT T "TESTING " TFILE)
                        (CLOSEF (OPENTEXTSTREAM TFILE))
                else (PRINTOUT T "Converting " TFILE "...")
                      (TEDIT.FORMAT.HARDCOPY (SETQ TEXTSTREAM (OPENTEXTSTREAM TFILE))
                             PSFILE T NIL NIL NIL (if (EQ REDOFLG 'IP)
                                                      then 'INTERPRESS
                                                    else 'POSTSCRIPT))
                      (printout T " DONE" T)
                      (CLOSEF? TEXTSTREAM]
       (T (PRINTOUT T "no such file " T])
)

[XCL:REINSTALL-ADVICE 'TEDIT.PROMPTPRINT :BEFORE '((:LAST (PRIN1 MSG T]

(READVISE TEDIT.PROMPTPRINT)

(RPAQQ BADFILESFILE /home/larry/id/BADFILES)

(RPAQ BADFS (OPENSTREAM BADFILESFILE 'APPEND))

(RPAQ BADFILES (SUBSET (READFILE BADFILESFILE)
                          (FUNCTION INFILEP)))
(DECLARE%: DONTCOPY
  (FILEMAP (NIL (573 4459 (BADFILE 583 . 958) (MAKE-PS 960 . 4457)))))
STOP
