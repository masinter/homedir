(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "INTERLISP" BASE 10)

(FILECREATED "26-Nov-2021 10:23:12" {DSK}<home>larry>id>FONTCOMPARE.;5 7260   

      changes to%:  (FNS UNPACKFONT UNPACK/HUNK UNPACK/BITMAP UNPACK/TYPELESS COMPAREFONTS)
                    (FUNCTIONS UNPACKRECORD)
                    (VARS FONTCOMPARECOMS)

      previous date%: "24-Nov-2021 19:16:05" {DSK}<home>larry>id>FONTCOMPARE.;1)


(PRETTYCOMPRINT FONTCOMPARECOMS)

(RPAQQ FONTCOMPARECOMS ((FNS COMPAREFONTS UNPACK/BITMAP UNPACK/HUNK UNPACK/TYPELESS UNPACKFONT)
                            (FUNCTIONS UNPACKRECORD)))
(DEFINEQ

(COMPAREFONTS
  [LAMBDA (X Y)                                              (* ; 
                                                           "Edited 24-Nov-2021 16:28 by larry")
    (COMPARELISTS (UNPACKFONT X)
           (UNPACKFONT Y])

(UNPACK/BITMAP
  [LAMBDA (BITMAP)                                           (* ; 
                                                           "Edited 25-Nov-2021 10:39 by larry")
                                                             (* rrb "22-DEC-82 11:09")

    (* ;; "makes a copy of an existing BitMap")

    (PROG (NEWBITMAP)
          (BITBLT (SETQ BITMAP (\DTEST BITMAP 'BITMAP))
                 0 0 (SETQ NEWBITMAP (LIST "BITMAP" (BITMAPWIDTH BITMAP)
                                           (ffetch BITMAPHEIGHT of BITMAP)
                                           (ffetch BITMAPBITSPERPIXEL of BITMAP)))
                 0 0 NIL NIL 'INPUT 'REPLACE 0)
          (RETURN NEWBITMAP])

(UNPACK/HUNK
  [LAMBDA (DATUM GCTYPE SIZE)                                (* ; 
                                                           "Edited 25-Nov-2021 11:30 by larry")
                                                             (* ; 
                                                           "Edited 25-Nov-2021 10:27 by larry")
                                                             (* ; 
                                                           "Edited 25-Nov-2021 10:08 by larry")
                                                             (* ; "Edited  7-Aug-87 10:07 by jop")

    (* ;; "inspect/hunk")

    (PROG [(ELTSPEC (SELECTC GCTYPE
                        (CODEBLOCK.GCT (HELP DATUM "CCODEP")
                                       (RETURN DARUM))
                        (PTRBLOCK.GCT                        (* ; 
                                                       "Pointers live here, so size is unambiguous")
                                      '\INSPECT.FETCH.PTR)
                        (PROGN                               (* ; 
                                         "Completely unboxed, so we don't know how to interpret it")
                               '\INSPECT.FETCH.32]
          (RETURN (CONS "HUNK" (for I from 0 to (SUB1 (IQUOTIENT (UNFOLD SIZE BITSPERWORD
                                                                                    )
                                                                         32))
                                  collect (UNPACKFONT (APPLY* ELTSPEC DATUM I])

(UNPACK/TYPELESS
  [LAMBDA (ITEM)                                             (* ; 
                                                           "Edited 25-Nov-2021 09:38 by larry")
                                                             (* ; "Edited  2-Feb-87 17:08 by jop")

    (* ;; "based on INSPECT/TYPELESS")

    (LET (HDR TRLR)
         (COND
            ((AND (type? ARRAYBLOCK ITEM)
                  [\VALIDADDRESSP (SETQ HDR (\ADDBASE ITEM (IMINUS \ArrayBlockHeaderWords]
                  (EQ (fetch (ARRAYBLOCK PASSWORD) of HDR)
                      \ArrayBlockPassword)
                  (fetch (ARRAYBLOCK INUSE) of HDR)
                  (\VALIDADDRESSP (SETQ TRLR (fetch (ARRAYBLOCK TRAILER) of HDR)))
                  (EQ (fetch (ARRAYBLOCK PASSWORD) of TRLR)
                      \ArrayBlockPassword))
             (UNPACK/HUNK ITEM (fetch (ARRAYBLOCK GCTYPE) of HDR)
                    (IDIFFERENCE (UNFOLD (fetch (ARRAYBLOCK ARLEN) of HDR)
                                        WORDSPERCELL)
                           \ArrayBlockOverheadWords)))
            (T ITEM])

(UNPACKFONT
  [LAMBDA (X CTX TYPE)                                       (* ; 
                                                           "Edited 26-Nov-2021 10:22 by larry")
                                                             (* ; 
                                                           "Edited 26-Nov-2021 09:10 by larry")
    (SELECTQ (OR TYPE (SETQ TYPE (TYPENAME X)))
        ((LITATOM SMALLP FIXP BIGNUM RATIO) 
             X)
        (NIL (UNPACK/TYPELESS X))
        (LISTP (CONS (UNPACKFONT (CAR X))
                     (UNPACKFONT (CDR X))))
        (FONTCLASS [LIST :CLASS (fetch (FONTCLASS FONTCLASSNAME) of X)
                         :NUMBER
                         (fetch (FONTCLASS PRETTYFONT#) of X)
                         :FDS
                         (for Y TMP in FONTTYPES
                            when [SETQ TMP (SELECTQ Y
                                                   (DISPLAY (fetch (FONTCLASS DISPLAYFD)
                                                               of X))
                                                   (PRESS (fetch (FONTCLASS PRESSFD) of
                                                                                         X))
                                                   (INTERPRESS (fetch (FONTCLASS INTERPRESSFD)
                                                                  of X))
                                                   (CDR (ASSOC X (fetch (FONTCLASS OTHERFDS)
                                                                    of X]
                            collect (CONS Y (UNPACKFONT TMP Y])
        (FONTDESCRIPTOR 
             (UNPACKRECORD FONTDESCRIPTOR X))
        (CHARSETINFO (UNPACKRECORD CHARSETINFO X))
        (BITMAP (LET [(NDC (OPENSTREAM "{NODIRCORE}" 'BOTH 'NEW]
                     (HPRINT X NDC T NIL)
                     (SETFILEPTR NDC 0)
                     (READFILE NDC)))
        (HELP X TYPE])
)

(DEFMACRO UNPACKRECORD (RECORDNAME VAR)
   [LET [(DEF (RECORD.REMOVE.COMMENTS (GETDEF RECORDNAME 'RECORDS]
        (if (NOT DEF)
            then (HELP RECORDNAME "no such record")
                  `',VAR
          else `(LIST ,@(FOR FIELD IN (CADDR DEF)
                               WHEN (IF (LISTP FIELD)
                                            THEN (SETQ FIELD (CAR FIELD))
                                          ELSE FIELD)
                               COLLECT `(CONS ',FIELD (UNPACKFONT (FETCH (,RECORDNAME
                                                                                      ,FIELD)
                                                                             OF ,VAR])
(DECLARE%: DONTCOPY
  (FILEMAP (NIL (612 6475 (COMPAREFONTS 622 . 878) (UNPACK/BITMAP 880 . 1617) (UNPACK/HUNK 1619 . 3251) 
(UNPACK/TYPELESS 3253 . 4429) (UNPACKFONT 4431 . 6473)))))
STOP
